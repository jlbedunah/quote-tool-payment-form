<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Form - Quote Tool (Modern API)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.authorize.net/v1/Accept.js" charset="utf-8"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#fef2f2',
                            500: '#CA1824',
                            600: '#B0151F',
                            700: '#96121A',
                        },
                        brand: '#CA1824'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header Banner -->
    <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-4xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-brand rounded-lg flex items-center justify-center mr-3">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">My Bookkeepers.com</h1>
                        <p class="text-sm text-gray-600">Passionate About Bookkeeping</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-6 py-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Payment Form</h1>
            <p class="text-lg text-gray-600">Complete your quote payment</p>
        </div>

        <form id="paymentForm" class="bg-white rounded-xl shadow-lg overflow-hidden">
            <!-- Quote Summary Section -->
            <div class="p-8 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
                <div class="flex items-center mb-6">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-semibold text-gray-800">Quote Summary</h2>
                </div>
                
                <div id="quoteSummary" class="space-y-4 mb-6">
                    <!-- Quote items will be populated here -->
                </div>
                
                <div class="flex justify-between items-center p-4 bg-white rounded-lg border-2 border-brand">
                    <span class="text-xl font-semibold text-gray-800">Total:</span>
                    <span id="totalAmount" class="text-2xl font-bold" style="color: #CA1824;">$0.00</span>
                </div>
            </div>

            <!-- Customer Information Section -->
            <div class="p-8 border-b border-gray-200">
                <div class="flex items-center mb-6">
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-semibold text-gray-800">Customer Information</h2>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="firstName" class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                        <input type="text" id="firstName" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="lastName" class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                        <input type="text" id="lastName" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label for="company" class="block text-sm font-medium text-gray-700 mb-2">Company</label>
                        <input type="text" id="company" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                        <input type="email" id="email" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Phone *</label>
                        <input type="tel" id="phone" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700 mb-2">Address *</label>
                        <input type="text" id="address" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                    <div>
                        <label for="city" class="block text-sm font-medium text-gray-700 mb-2">City *</label>
                        <input type="text" id="city" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="state" class="block text-sm font-medium text-gray-700 mb-2">State *</label>
                        <input type="text" id="state" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="zip" class="block text-sm font-medium text-gray-700 mb-2">ZIP Code *</label>
                        <input type="text" id="zip" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                </div>
            </div>

            <!-- Payment Information Section -->
            <div class="p-8 border-b border-gray-200">
                <div class="flex items-center mb-6">
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-semibold text-gray-800">Payment Information</h2>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="cardNumber" class="block text-sm font-medium text-gray-700 mb-2">Card Number *</label>
                        <input type="text" id="cardNumber" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                               placeholder="1234 5678 9012 3456" maxlength="19">
                    </div>
                    <div>
                        <label for="cardCode" class="block text-sm font-medium text-gray-700 mb-2">CVV *</label>
                        <input type="text" id="cardCode" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                               placeholder="123" maxlength="4">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label for="expDate" class="block text-sm font-medium text-gray-700 mb-2">Expiration Date *</label>
                        <input type="text" id="expDate" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                               placeholder="MM/YY" maxlength="5">
                    </div>
                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">Amount *</label>
                        <input type="text" id="amount" required readonly
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700 font-semibold">
                    </div>
                </div>
            </div>

            <!-- Line Items Data Container (for Modern API) -->
            <div id="lineItemsContainer" style="display: none;">
                <!-- Line items will be stored here as JSON -->
            </div>

            <!-- Submit Section -->
            <div class="p-8 bg-gray-50">
                <div class="text-center">
                    <button type="submit" class="text-white px-8 py-4 rounded-lg transition-all duration-200 font-semibold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1"
                            style="background-color: #CA1824;" 
                            onmouseover="this.style.backgroundColor='#B0151F'" 
                            onmouseout="this.style.backgroundColor='#CA1824'">
                        <svg class="w-6 h-6 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                        Process Payment
                    </button>
                    <p class="text-sm text-gray-500 mt-4">
                        Secure payment processing by Authorize.net
                    </p>
                </div>
            </div>
        </form>
    </div>

    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.toString()) {
                populateQuoteSummary(urlParams);
                populateCustomerInfo(urlParams);
            }
        });

        function populateCustomerInfo(urlParams) {
            // Populate customer information from URL parameters
            const fields = ['firstName', 'lastName', 'companyName', 'email', 'phone', 'address1', 'city', 'state', 'zip'];
            fields.forEach(field => {
                const value = urlParams.get(field);
                if (value) {
                    const element = document.getElementById(field === 'companyName' ? 'company' : field === 'address1' ? 'address' : field);
                    if (element) {
                        element.value = decodeURIComponent(value);
                    }
                }
            });
        }

        function populateQuoteSummary(urlParams) {
            const quoteSummary = document.getElementById('quoteSummary');
            const totalAmount = document.getElementById('totalAmount');
            const amountInput = document.getElementById('amount');
            const lineItemsContainer = document.getElementById('lineItemsContainer');
            
            let total = 0;
            let serviceIndex = 0;
            let summaryHTML = '';
            let lineItems = [];
            
            // Process each service
            while (urlParams.has(`productName${serviceIndex}`)) {
                const serviceName = urlParams.get(`productName${serviceIndex}`);
                const quantity = urlParams.get(`quantity${serviceIndex}`) || '1';
                const description = urlParams.get(`description${serviceIndex}`) || '';
                const unitCost = urlParams.get(`unitCost${serviceIndex}`) || '0';
                const subtotal = urlParams.get(`subtotal${serviceIndex}`) || '0';
                
                console.log(`Processing service ${serviceIndex}:`, {
                    serviceName,
                    quantity,
                    description,
                    unitCost,
                    subtotal
                });
                
                const subtotalNum = parseFloat(subtotal);
                total += subtotalNum;
                
                // Generate summary HTML
                summaryHTML += `
                    <div class="flex justify-between items-center p-3 bg-white rounded-lg border">
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">${serviceName}</div>
                            ${description ? `<div class="text-sm text-gray-500">${description}</div>` : ''}
                            <div class="text-sm text-gray-600">Qty: ${quantity} × $${parseFloat(unitCost).toFixed(2)}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-gray-800">$${subtotalNum.toFixed(2)}</div>
                        </div>
                    </div>
                `;
                
                // Generate Modern API line item (JSON format)
                const lineItem = {
                    itemId: (serviceIndex + 1).toString(),
                    name: serviceName.substring(0, 31), // Max 31 chars
                    description: description.substring(0, 255), // Max 255 chars
                    quantity: Math.max(1, Math.floor(parseFloat(quantity) || 1)),
                    unitPrice: Math.max(0.01, parseFloat(unitCost) || 0.01)
                };
                
                console.log(`Generated line item ${serviceIndex}:`, lineItem);
                lineItems.push(lineItem);
                
                serviceIndex++;
            }
            
            quoteSummary.innerHTML = summaryHTML;
            totalAmount.textContent = total.toFixed(2);
            amountInput.value = total.toFixed(2);
            lineItemsContainer.textContent = JSON.stringify(lineItems);
            
            console.log('All line items:', lineItems);
        }

        // Format card number input
        document.getElementById('cardNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            if (formattedValue.length > 19) {
                formattedValue = formattedValue.substring(0, 19);
            }
            e.target.value = formattedValue;
        });

        // Format expiration date input
        document.getElementById('expDate').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });

        // Handle form submission with Accept.js and Modern API
        document.getElementById('paymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const expDate = document.getElementById('expDate').value;
            const cardCode = document.getElementById('cardCode').value;
            
            // Basic validation
            if (cardNumber.length < 13 || cardNumber.length > 19) {
                showError('Please enter a valid card number');
                return;
            }
            
            if (!expDate.match(/^\d{2}\/\d{2}$/)) {
                showError('Please enter a valid expiration date (MM/YY)');
                return;
            }
            
            if (cardCode.length < 3 || cardCode.length > 4) {
                showError('Please enter a valid CVV');
                return;
            }
            
            // Show loading state
            const submitBtn = document.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Processing...';
            submitBtn.disabled = true;
            
            try {
                // Use Accept.js to get secure payment data
                const secureData = await getSecurePaymentData(cardNumber, expDate, cardCode);
                
                // Collect customer data
                const customerData = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    companyName: document.getElementById('company').value,
                    address1: document.getElementById('address').value,
                    address2: '',
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    zip: document.getElementById('zip').value,
                    country: 'US',
                    phoneNumber: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    amount: document.getElementById('amount').value
                };
                
                // Get line items from the container
                const lineItemsData = document.getElementById('lineItemsContainer').textContent;
                const lineItems = lineItemsData ? JSON.parse(lineItemsData) : [];
                
                console.log('Sending to Modern API:', {
                    secureData: secureData,
                    customerData: customerData,
                    lineItems: lineItems
                });
                
                // Send to our Modern API endpoint
                const response = await fetch('/api/process-payment-modern', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-vercel-protection-bypass': 'F9A72B1C8E5D4F0A6C3B7E2D9A8F5C1E'
                    },
                    body: JSON.stringify({
                        secureData: secureData,
                        customerData: customerData,
                        lineItems: lineItems
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result);
                } else {
                    showError(result.error || 'Payment failed. Please try again.');
                }
                
            } catch (error) {
                console.error('Payment error:', error);
                showError('Network error. Please check your connection and try again.');
            } finally {
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Accept.js function to get secure payment data
        function getSecurePaymentData(cardNumber, expDate, cardCode) {
            return new Promise((resolve, reject) => {
                // Check if Accept.js is loaded
                if (typeof Accept === 'undefined') {
                    reject(new Error('Accept.js library not loaded. Please refresh the page.'));
                    return;
                }
                
                // For now, we'll use test credentials until Client Key is added to Vercel
                const authData = {
                    clientKey: '6AB64nP5R6', // Test Client Key for sandbox
                    apiLoginID: '5KP3u95bQpv' // Test API Login ID for sandbox
                };
                
                const cardData = {
                    cardNumber: cardNumber,
                    month: expDate.split('/')[0],
                    year: '20' + expDate.split('/')[1],
                    cardCode: cardCode
                };
                
                console.log('Sending to Accept.js:', { authData, cardData });
                
                try {
                    Accept.dispatchData(authData, cardData, (response) => {
                        console.log('Accept.js response:', response);
                        
                        if (response.messages.resultCode === 'Ok') {
                            resolve({
                                dataDescriptor: response.opaqueData.dataDescriptor,
                                dataValue: response.opaqueData.dataValue
                            });
                        } else {
                            const errorMessage = response.messages.message[0].text;
                            console.error('Accept.js error:', errorMessage);
                            reject(new Error(errorMessage));
                        }
                    });
                } catch (error) {
                    console.error('Accept.js dispatch error:', error);
                    reject(new Error('Failed to process card data. Please check your card information.'));
                }
            });
        }

        function showError(message) {
            // Remove any existing error messages
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            
            // Create error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4';
            errorDiv.textContent = message;
            
            // Insert before submit button
            const submitSection = document.querySelector('.p-8.bg-gray-50');
            submitSection.insertBefore(errorDiv, submitSection.firstChild);
            
            // Scroll to error
            errorDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function showSuccess(result) {
            // Replace form with success message
            const form = document.getElementById('paymentForm');
            form.innerHTML = `
                <div class="p-8 text-center">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Payment Successful!</h2>
                    <p class="text-gray-600 mb-4">Your payment has been processed successfully.</p>
                    ${result.transactionId ? `<p class="text-sm text-gray-500">Transaction ID: ${result.transactionId}</p>` : ''}
                    <div class="mt-6">
                        <a href="/quote-tool.html" class="inline-block bg-brand text-white px-6 py-3 rounded-lg hover:bg-opacity-90 transition-all duration-200">
                            Return to Quote Tool
                        </a>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Form - Quote Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#fef2f2',
                            500: '#CA1824',
                            600: '#B0151F',
                            700: '#96121A',
                        },
                        brand: '#CA1824'
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for the searchable dropdown */
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            /*position the autocomplete items to be the same width as the container:*/
            top: 100%;
            left: 0;
            right: 0;
        }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
        }

        .autocomplete-items div:hover {
            /*when hovering an item:*/
            background-color: #e9e9e9;
        }

        .autocomplete-active {
            /*when navigating through the items using the arrow keys:*/
            background-color: DodgerBlue !important;
            color: #ffffff;
        }

        /* Card number formatting */
        .card-number-input {
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <!-- Header Banner -->
        <div class="w-full max-w-4xl bg-white rounded-t-xl shadow-lg p-6 flex items-center justify-center mb-4" style="background-color: #CA1824;">
            <img src="https://mybookkeepers.com/wp-content/uploads/2023/09/MyBookkeepers-Logo-White-1.png" alt="MyBookkeepers Logo" class="h-12">
        </div>

        <div class="w-full max-w-4xl bg-white rounded-b-xl shadow-lg overflow-hidden">
            <div class="p-8 border-b border-gray-200">
                <div class="flex items-center mb-6">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-semibold text-gray-800">Quote Summary</h2>
                </div>
                <div id="quoteSummary" class="space-y-4 text-gray-700">
                    <!-- Quote details will be populated here by JavaScript -->
                </div>
                <div class="mt-6 pt-4 border-t border-gray-200 flex justify-between items-center">
                    <span class="text-xl font-bold text-gray-800">Total:</span>
                    <span id="totalAmount" class="text-2xl font-extrabold" style="color: #CA1824;">$0.00</span>
                </div>
            </div>

            <!-- Customer Information Section -->
            <div class="p-8 border-b border-gray-200">
                <div class="flex items-center mb-6">
                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-semibold text-gray-800">Customer Information</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="firstName" class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                        <input type="text" id="firstName" name="firstName" readonly
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700">
                    </div>
                    <div>
                        <label for="lastName" class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                        <input type="text" id="lastName" name="lastName" readonly
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700">
                    </div>
                    <div class="md:col-span-2">
                        <label for="company" class="block text-sm font-medium text-gray-700 mb-2">Company Name</label>
                        <input type="text" id="company" name="companyName" readonly
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="email" name="email" readonly
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                        <input type="tel" id="phone" name="phone" readonly
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700">
                    </div>
                    <div class="md:col-span-2">
                        <label for="address" class="block text-sm font-medium text-gray-700 mb-2">Address Line 1</label>
                        <input type="text" id="address" name="address1" readonly
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700">
                    </div>
                    <div>
                        <label for="city" class="block text-sm font-medium text-gray-700 mb-2">City</label>
                        <input type="text" id="city" name="city" readonly
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700">
                    </div>
                    <div>
                        <label for="state" class="block text-sm font-medium text-gray-700 mb-2">State</label>
                        <input type="text" id="state" name="state" readonly
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700">
                    </div>
                    <div>
                        <label for="zip" class="block text-sm font-medium text-gray-700 mb-2">Zip Code</label>
                        <input type="text" id="zip" name="zip" readonly
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700">
                    </div>
                </div>
            </div>

            <form id="paymentForm" class="bg-white rounded-b-xl shadow-lg overflow-hidden">
                <!-- Payment Information Section -->
                <div class="p-8 border-b border-gray-200">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-semibold text-gray-800">Payment Information</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="cardNumber" class="block text-sm font-medium text-gray-700 mb-2">Card Number *</label>
                            <input type="text" id="cardNumber" name="cardNumber" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 card-number-input"
                                   placeholder="1234 5678 9012 3456" maxlength="19">
                        </div>
                        <div>
                            <label for="cardCode" class="block text-sm font-medium text-gray-700 mb-2">CVV *</label>
                            <input type="text" id="cardCode" name="cardCode" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                   placeholder="123" maxlength="4">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <div>
                            <label for="expDate" class="block text-sm font-medium text-gray-700 mb-2">Expiration Date *</label>
                            <input type="text" id="expDate" name="expDate" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                   placeholder="MM/YY" maxlength="5">
                        </div>
                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">Amount *</label>
                            <input type="text" id="amount" name="amount" required readonly
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700 font-semibold">
                        </div>
                    </div>
                </div>

                <!-- Line Items Data Container (hidden) -->
                <div id="lineItemsContainer" style="display: none;">
                    <!-- Line items will be stored here as JSON -->
                </div>

                <!-- Submit Section -->
                <div class="p-8 bg-gray-50">
                    <div class="text-center">
                        <button type="submit" class="text-white px-8 py-4 rounded-lg transition-all duration-200 font-semibold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1"
                                style="background-color: #CA1824;" 
                                onmouseover="this.style.backgroundColor='#B0151F'" 
                                onmouseout="this.style.backgroundColor='#CA1824'">
                            <svg class="w-6 h-6 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                            Process Payment
                        </button>
                        <p class="text-sm text-gray-500 mt-4">
                            Secure payment processing by Authorize.net
                        </p>
                    </div>
                </div>
            </form>
        </div>

        <!-- Success/Error Message Display -->
        <div id="messageContainer" class="w-full max-w-4xl mt-4 p-4 rounded-lg text-center hidden"></div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            populateQuoteSummary(urlParams);
            populateCustomerInfo(urlParams);
            
            // Format card number input (add spaces every 4 digits)
            document.getElementById('cardNumber').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                e.target.value = formattedValue;
            });

            // Format expiration date input
            document.getElementById('expDate').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
                if (value.length > 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            });

            // Format CVV input (only digits)
            document.getElementById('cardCode').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });

            // Handle form submission with server-side processing
            document.getElementById('paymentForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
                const expDate = document.getElementById('expDate').value;
                const cardCode = document.getElementById('cardCode').value;
                
                // Client-side validation
                if (cardNumber.length < 13 || cardNumber.length > 19) {
                    showError('Please enter a valid card number');
                    return;
                }
                
                if (!expDate.match(/^\d{2}\/\d{2}$/)) {
                    showError('Please enter a valid expiration date (MM/YY)');
                    return;
                }
                
                if (cardCode.length < 3 || cardCode.length > 4) {
                    showError('Please enter a valid CVV');
                    return;
                }
                
                // Show loading state
                const submitBtn = document.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Processing...';
                submitBtn.disabled = true;
                
                try {
                    // Collect form data
                    const formData = {
                        cardNumber: cardNumber,
                        expDate: expDate,
                        cardCode: cardCode,
                        firstName: document.getElementById('firstName').value,
                        lastName: document.getElementById('lastName').value,
                        companyName: document.getElementById('company').value,
                        address1: document.getElementById('address').value,
                        address2: '', // Not present in form
                        city: document.getElementById('city').value,
                        state: document.getElementById('state').value,
                        zip: document.getElementById('zip').value,
                        country: 'US', // Default to US
                        phoneNumber: document.getElementById('phone').value,
                        email: document.getElementById('email').value,
                        amount: document.getElementById('amount').value
                    };
                    
                    // Collect line items (already stored in lineItemsContainer as JSON)
                    const lineItemsJson = document.getElementById('lineItemsContainer').textContent;
                    if (lineItemsJson) {
                        formData.lineItems = JSON.parse(lineItemsJson);
                    } else {
                        formData.lineItems = [];
                    }

                    console.log('Sending payment data to server:', {
                        ...formData,
                        cardNumber: cardNumber.substring(0, 4) + '****',
                        cardCode: '***'
                    });
                    
                    // Debug: Check each field individually
                    console.log('Field validation check:', {
                        cardNumber: !!formData.cardNumber,
                        expDate: !!formData.expDate,
                        cardCode: !!formData.cardCode,
                        firstName: !!formData.firstName,
                        lastName: !!formData.lastName,
                        address1: !!formData.address1,
                        city: !!formData.city,
                        state: !!formData.state,
                        zip: !!formData.zip,
                        email: !!formData.email,
                        amount: !!formData.amount
                    });

                    // Send to our server-side API
                    const response = await fetch('/api/process-payment-server', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-vercel-protection-bypass': 'F9A72B1C8E5D4F0A6C3B7E2D9A8F5C1E'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    const raw = await response.text();
                    let result;
                    try {
                        result = JSON.parse(raw);
                    } catch (e) {
                        console.error('Non-JSON response:', raw);
                        throw new Error(raw?.slice(0, 200) || 'Server returned non-JSON response');
                    }
                    console.log('Payment response:', result);
                    
                    if (result.success) {
                        // Payment successful
                        showSuccess(result);
                    } else {
                        // Payment failed
                        showError(result.error || 'Payment failed. Please try again.');
                    }
                    
                } catch (error) {
                    console.error('Payment error:', error);
                    showError(error.message || 'Network error. Please check your connection and try again.');
                } finally {
                    // Reset button
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            });

            function showError(message) {
                // Remove any existing error messages
                const existingError = document.querySelector('.error-message');
                if (existingError) {
                    existingError.remove();
                }

                const messageContainer = document.getElementById('messageContainer');
                if (!messageContainer) {
                    console.error('Message container not found');
                    alert('Error: ' + message);
                    return;
                }
                
                messageContainer.classList.remove('hidden', 'bg-green-100', 'text-green-800');
                messageContainer.classList.add('bg-red-100', 'text-red-800', 'error-message');
                messageContainer.innerHTML = `<p class="font-semibold">Error:</p><p>${message}</p>`;
                messageContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            function showSuccess(result) {
                // Remove any existing error messages
                const existingError = document.querySelector('.error-message');
                if (existingError) {
                    existingError.remove();
                }

                const messageContainer = document.getElementById('messageContainer');
                if (!messageContainer) {
                    console.error('Message container not found');
                    alert('Payment successful! Transaction ID: ' + (result.transactionId || 'N/A'));
                    return;
                }
                
                messageContainer.classList.remove('hidden', 'bg-red-100', 'text-red-800');
                messageContainer.classList.add('bg-green-100', 'text-green-800');
                messageContainer.innerHTML = `
                    <p class="font-semibold text-lg">Payment Approved!</p>
                    <p>Transaction ID: ${result.transactionId || 'N/A'}</p>
                    <p>Amount: $${result.amount || 'N/A'}</p>
                    <p>Message: ${result.message || 'Your payment was successful.'}</p>
                    <button onclick="window.location.href='quote-tool.html'" 
                            class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                        Return to Quote Tool
                    </button>
                `;
                messageContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                const paymentForm = document.getElementById('paymentForm');
                if (paymentForm) {
                    paymentForm.style.display = 'none'; // Hide the form
                }
            }

            function populateCustomerInfo(urlParams) {
                const customerFields = ['firstName', 'lastName', 'company', 'email', 'phone', 'city', 'state', 'zip'];
                customerFields.forEach(field => {
                    const element = document.getElementById(field);
                    if (element) {
                        element.value = urlParams.get(field) || '';
                    }
                });
                
                // Handle address1 separately since the field ID is 'address' but URL param is 'address1'
                const addressElement = document.getElementById('address');
                if (addressElement) {
                    addressElement.value = urlParams.get('address1') || '';
                }
            }

            function populateQuoteSummary(urlParams) {
                const quoteSummary = document.getElementById('quoteSummary');
                const totalAmount = document.getElementById('totalAmount');
                const amountInput = document.getElementById('amount');
                const lineItemsContainer = document.getElementById('lineItemsContainer'); // This will store JSON
                
                let total = 0;
                let serviceIndex = 0;
                let summaryHTML = '';
                const lineItems = []; // Array to hold line item objects

                while (urlParams.has(`productName${serviceIndex}`)) {
                    const serviceName = urlParams.get(`productName${serviceIndex}`);
                    const quantity = urlParams.get(`quantity${serviceIndex}`);
                    const description = urlParams.get(`description${serviceIndex}`);
                    const unitCost = urlParams.get(`unitCost${serviceIndex}`);
                    const subtotal = urlParams.get(`subtotal${serviceIndex}`);

                    if (serviceName && quantity && unitCost) {
                        const currentSubtotal = parseFloat(subtotal) || (parseFloat(quantity) * parseFloat(unitCost));
                        total += currentSubtotal;

                        summaryHTML += `
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium">${serviceName} (x${quantity})</p>
                                    ${description ? `<p class="text-sm text-gray-500">${description}</p>` : ''}
                                </div>
                                <span class="font-semibold">$${currentSubtotal.toFixed(2)}</span>
                            </div>
                        `;

                        // Add to line items array for JSON
                        lineItems.push({
                            itemId: (serviceIndex + 1).toString(),
                            name: serviceName,
                            description: description || '',
                            quantity: Math.max(1, Math.floor(parseFloat(quantity) || 1)),
                            unitPrice: Math.max(0.01, parseFloat(unitCost) || 0.01),
                            taxable: false // Assuming not taxable for now
                        });
                    }
                    serviceIndex++;
                }

                quoteSummary.innerHTML = summaryHTML;
                totalAmount.textContent = `$${total.toFixed(2)}`;
                amountInput.value = total.toFixed(2);

                // Store line items as JSON in the hidden container
                lineItemsContainer.textContent = JSON.stringify(lineItems);
            }
        });
    </script>
</body>
</html>

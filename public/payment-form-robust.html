<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Form - Quote Tool</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8ZN40WHZ74"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-8ZN40WHZ74');
    </script>
    
    <!-- Hyros Tracking Script -->
    <script>
    var head = document.head;
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = "https://t.mybookkeepers.com/v1/lst/universal-script?ph=cfa99e7cf0bfaa3f377a76c9efca19d672fdc7eab55b71a9f40e80623231ee9d&tag=!clicked&ref_url=" + encodeURI(document.URL) ;
    head.appendChild(script);
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#fef2f2',
                            500: '#CA1824',
                            600: '#B0151F',
                            700: '#96121A',
                        },
                        brand: '#CA1824'
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for the searchable dropdown */
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            /*position the autocomplete items to be the same width as the container:*/
            top: 100%;
            left: 0;
            right: 0;
        }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
        }

        .autocomplete-items div:hover {
            /*when hovering an item:*/
            background-color: #e9e9e9;
        }

        .autocomplete-active {
            /*when navigating through the items using the arrow keys:*/
            background-color: DodgerBlue !important;
            color: #ffffff;
        }

        /* Card number formatting */
        .card-number-input {
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <!-- Header Banner -->
        <div class="w-full max-w-4xl bg-white rounded-t-xl shadow-lg p-6 flex items-center justify-center mb-4" style="background-color: #CA1824;">
            <div class="flex items-center bg-white rounded-lg px-4 py-2 shadow-lg">
                <!-- Red checkmark icon -->
                <div class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center mr-3">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <!-- Logo text -->
                <div class="text-left">
                    <div class="text-lg font-bold">
                        <span class="text-black">My</span>
                        <span class="text-red-600" style="color: #CA1824;">Bookkeepers.com</span>
                    </div>
                    <div class="text-xs text-gray-600 font-medium">Passionate About Bookkeeping</div>
                </div>
            </div>
        </div>

        <div class="w-full max-w-4xl bg-white rounded-b-xl shadow-lg overflow-hidden">
            <div class="p-8 border-b border-gray-200">
                <div class="flex items-center mb-6">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-semibold text-gray-800">Quote Summary</h2>
                </div>
                <div id="quoteSummary" class="space-y-4 text-gray-700">
                    <!-- Quote details will be populated here by JavaScript -->
                </div>

                <!-- Payment Plan Info (shown only for payment plans) -->
                <div id="paymentPlanInfo" class="hidden mt-4 bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-indigo-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <span class="font-semibold text-indigo-800">Payment Plan</span>
                    </div>
                    <div class="text-sm text-indigo-700 space-y-1">
                        <p>Total Amount: <span id="ppTotalAmount" class="font-semibold">$0.00</span></p>
                        <p>Split into <span id="ppInstallments" class="font-semibold">3</span> monthly payments</p>
                        <div class="mt-3 pt-2 border-t border-indigo-200">
                            <p class="text-indigo-800 font-medium">Today you'll be charged:</p>
                            <p class="text-2xl font-bold text-indigo-600" id="ppFirstPayment">$0.00</p>
                            <p class="text-xs text-indigo-600 mt-1">Remaining <span id="ppRemainingCount">2</span> payments of <span id="ppRemainingAmount">$0.00</span>/month will be charged automatically</p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-200 space-y-2 text-right">
                    <div>
                        <span class="text-xl font-bold text-gray-800">Due Today:</span>
                        <span id="dueTodayAmount" class="text-2xl font-extrabold ml-2" style="color: #CA1824;">$0.00</span>
                    </div>
                    <div id="subscriptionSummaryRow" class="text-sm text-gray-600 hidden">
                        Monthly Subscription: <span class="font-semibold" id="subscriptionSummaryAmount">$0.00</span> per month
                    </div>
                </div>
            </div>

            <!-- Customer Information Section -->
            <div class="p-8 border-b border-gray-200">
                <div class="flex items-center mb-6">
                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-semibold text-gray-800">Customer Information</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="firstName" class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                        <input type="text" id="firstName" name="firstName"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="lastName" class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                        <input type="text" id="lastName" name="lastName"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div class="md:col-span-2">
                        <label for="company" class="block text-sm font-medium text-gray-700 mb-2">Company Name</label>
                        <input type="text" id="company" name="companyName"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email (Primary)</label>
                        <input type="email" id="email" name="email" readonly
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700">
                    </div>
                    <div>
                        <label for="secondaryEmail" class="block text-sm font-medium text-gray-700 mb-2">Email (Secondary)</label>
                        <input type="email" id="secondaryEmail" name="secondaryEmail"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                        <input type="tel" id="phone" name="phone"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div class="md:col-span-2">
                        <label for="address" class="block text-sm font-medium text-gray-700 mb-2">Address Line 1</label>
                        <input type="text" id="address" name="address1"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div class="md:col-span-2">
                        <label for="address2" class="block text-sm font-medium text-gray-700 mb-2">Address Line 2</label>
                        <input type="text" id="address2" name="address2"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="city" class="block text-sm font-medium text-gray-700 mb-2">City</label>
                        <input type="text" id="city" name="city"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="state" class="block text-sm font-medium text-gray-700 mb-2">State</label>
                        <input type="text" id="state" name="state"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="zip" class="block text-sm font-medium text-gray-700 mb-2">Zip Code</label>
                        <input type="text" id="zip" name="zip"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                </div>
            </div>

            <!-- Billing Address Section -->
            <div class="p-8 border-b border-gray-200">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-semibold text-gray-800">Billing Address</h2>
                    </div>
                    <label class="inline-flex items-center text-sm text-gray-600">
                        <input type="checkbox" id="copyShippingToBilling" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                        <span class="ml-2">Same as shipping address</span>
                    </label>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="billingFirstName" class="block text-sm font-medium text-gray-700 mb-2">Billing First Name</label>
                        <input type="text" id="billingFirstName" name="billingFirstName" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="billingLastName" class="block text-sm font-medium text-gray-700 mb-2">Billing Last Name</label>
                        <input type="text" id="billingLastName" name="billingLastName" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div class="md:col-span-2">
                        <label for="billingCompany" class="block text-sm font-medium text-gray-700 mb-2">Billing Company</label>
                        <input type="text" id="billingCompany" name="billingCompany"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div class="md:col-span-2">
                        <label for="billingAddress1" class="block text-sm font-medium text-gray-700 mb-2">Billing Address Line 1</label>
                        <input type="text" id="billingAddress1" name="billingAddress1" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div class="md:col-span-2">
                        <label for="billingAddress2" class="block text-sm font-medium text-gray-700 mb-2">Billing Address Line 2</label>
                        <input type="text" id="billingAddress2" name="billingAddress2"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="billingCity" class="block text-sm font-medium text-gray-700 mb-2">Billing City</label>
                        <input type="text" id="billingCity" name="billingCity" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="billingState" class="block text-sm font-medium text-gray-700 mb-2">Billing State</label>
                        <input type="text" id="billingState" name="billingState" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="billingZip" class="block text-sm font-medium text-gray-700 mb-2">Billing Zip Code</label>
                        <input type="text" id="billingZip" name="billingZip" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="billingCountry" class="block text-sm font-medium text-gray-700 mb-2">Billing Country</label>
                        <input type="text" id="billingCountry" name="billingCountry" value="US"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                </div>
            </div>

            <form id="paymentForm" class="bg-white rounded-b-xl shadow-lg overflow-hidden">
                <!-- Payment Information Section -->
                <div class="p-8 border-b border-gray-200">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-semibold text-gray-800">Payment Information</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="cardNumber" class="block text-sm font-medium text-gray-700 mb-2">Card Number *</label>
                            <input type="text" id="cardNumber" name="cardNumber" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 card-number-input"
                                   placeholder="1234 5678 9012 3456" maxlength="19">
                        </div>
                        <div>
                            <label for="cardCode" class="block text-sm font-medium text-gray-700 mb-2">CVV *</label>
                            <input type="text" id="cardCode" name="cardCode" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                   placeholder="123" maxlength="4">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <div>
                            <label for="expDate" class="block text-sm font-medium text-gray-700 mb-2">Expiration Date *</label>
                            <input type="text" id="expDate" name="expDate" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                   placeholder="MM/YY" maxlength="5">
                        </div>
                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">Amount Due Today *</label>
                            <input type="text" id="amount" name="amount" required readonly
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700 font-semibold">
                        </div>
                    </div>
                </div>

                <!-- Line Items Data Container (hidden) -->
                <div id="lineItemsContainer" style="display: none;">
                    <!-- Line items will be stored here as JSON -->
                </div>
                <div id="subscriptionItemsContainer" style="display: none;">
                    <!-- Subscription items metadata will be stored here as JSON -->
                </div>

                <!-- Submit Section -->
                <div class="p-8 bg-gray-50">
                    <div class="text-center">
                        <button type="submit" class="text-white px-8 py-4 rounded-lg transition-all duration-200 font-semibold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1"
                                style="background-color: #CA1824;" 
                                onmouseover="this.style.backgroundColor='#B0151F'" 
                                onmouseout="this.style.backgroundColor='#CA1824'">
                            <svg class="w-6 h-6 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                            Process Payment
                        </button>
                        <div class="mt-4 flex items-center justify-center space-x-4">
                            <div class="flex items-center bg-gray-100 px-3 py-2 rounded-lg border">
                                <svg class="w-4 h-4 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                </svg>
                                <span class="text-sm font-medium text-gray-700">Secure Payment</span>
                            </div>
                            <div class="flex items-center bg-blue-50 px-3 py-2 rounded-lg border border-blue-200">
                                <span class="text-xs font-bold text-blue-800 mr-1">AUTHORIZE.NET</span>
                                <svg class="w-3 h-3 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Success/Error Message Display -->
        <div id="messageContainer" class="w-full max-w-4xl mt-4 p-4 rounded-lg text-center hidden"></div>

    </div>

    <script>
        // Check if quote is already paid before showing payment form
        async function checkQuoteStatus() {
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('email');
            const amount = urlParams.get('oneTimeTotal') || urlParams.get('grandTotal');
            const quoteId = urlParams.get('quoteId');

            if (!email && !quoteId) {
                // No email or quoteId in URL, proceed normally (might be direct access)
                return;
            }

            try {
                const response = await fetch('/api/check-quote-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        amount: amount,
                        quoteId: quoteId
                    })
                });
                
                const result = await response.json();
                
                if (result.isPaid) {
                    // Quote is already paid, redirect to success page
                    const successParams = new URLSearchParams();
                    successParams.append('message', 'This invoice has already been paid');
                    if (result.transactionId) {
                        successParams.append('transactionId', result.transactionId);
                    }
                    if (result.amount) {
                        successParams.append('amount', result.amount);
                    } else if (amount) {
                        successParams.append('amount', amount);
                    }
                    if (email) {
                        successParams.append('email', email);
                    }
                    if (result.quoteNumber) {
                        successParams.append('quoteNumber', result.quoteNumber);
                    }
                    
                    window.location.href = `/payment-success.html?${successParams.toString()}`;
                    return;
                }
                
                // Quote not paid, continue with normal payment form
            } catch (error) {
                console.error('Error checking quote status:', error);
                // On error, proceed with payment form (fail open)
                // Better to allow payment attempt than block legitimate payments
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // Check quote status first, before populating form
            await checkQuoteStatus();
            
            const urlParams = new URLSearchParams(window.location.search);
            populateQuoteSummary(urlParams);
            populateCustomerInfo(urlParams);
            const copyCheckbox = document.getElementById('copyShippingToBilling');
            if (copyCheckbox) {
                copyCheckbox.addEventListener('change', () => {
                    if (copyCheckbox.checked) {
                        copyShippingToBilling(true);
                    } else {
                        ['billingFirstName','billingLastName','billingCompany','billingAddress1','billingAddress2','billingCity','billingState','billingZip'].forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.value = '';
                        });
                        const billingCountry = document.getElementById('billingCountry');
                        if (billingCountry && !billingCountry.value) billingCountry.value = 'US';
                    }
                });
            }

            const shippingFieldsForCopy = ['firstName', 'lastName', 'company', 'address', 'address2', 'city', 'state', 'zip'];
            shippingFieldsForCopy.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', () => {
                        const checkbox = document.getElementById('copyShippingToBilling');
                        if (checkbox && checkbox.checked) {
                            copyShippingToBilling();
                        }
                    });
                }
            });
            
            // Format card number input (add spaces every 4 digits)
            document.getElementById('cardNumber').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                e.target.value = formattedValue;
            });

            // Format expiration date input
            document.getElementById('expDate').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
                if (value.length > 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            });

            // Format CVV input (only digits)
            document.getElementById('cardCode').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });

            // Handle form submission with server-side processing
            document.getElementById('paymentForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
                const expDate = document.getElementById('expDate').value;
                const cardCode = document.getElementById('cardCode').value;
                
                // Client-side validation
                if (cardNumber.length < 13 || cardNumber.length > 19) {
                    showError('Please enter a valid card number');
                    return;
                }
                
                if (!expDate.match(/^\d{2}\/\d{2}$/)) {
                    showError('Please enter a valid expiration date (MM/YY)');
                    return;
                }
                
                if (cardCode.length < 3 || cardCode.length > 4) {
                    showError('Please enter a valid CVV');
                    return;
                }
                
                // Show loading state
                const submitBtn = document.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Processing...';
                submitBtn.disabled = true;
                
                try {
                    // Collect form data
                    const formData = {
                        cardNumber: cardNumber,
                        expDate: expDate,
                        cardCode: cardCode,
                        firstName: document.getElementById('firstName').value,
                        lastName: document.getElementById('lastName').value,
                        companyName: document.getElementById('company').value,
                        address1: document.getElementById('address').value,
                        address2: document.getElementById('address2').value,
                        city: document.getElementById('city').value,
                        state: document.getElementById('state').value,
                        zip: document.getElementById('zip').value,
                        country: 'US',
                        phoneNumber: document.getElementById('phone').value,
                        email: document.getElementById('email').value,
                        secondaryEmail: document.getElementById('secondaryEmail').value,
                        amount: document.getElementById('amount').value,
                        billingFirstName: document.getElementById('billingFirstName').value,
                        billingLastName: document.getElementById('billingLastName').value,
                        billingCompany: document.getElementById('billingCompany').value,
                        billingAddress1: document.getElementById('billingAddress1').value,
                        billingAddress2: document.getElementById('billingAddress2').value,
                        billingCity: document.getElementById('billingCity').value,
                        billingState: document.getElementById('billingState').value,
                        billingZip: document.getElementById('billingZip').value,
                        billingCountry: document.getElementById('billingCountry').value || 'US'
                    };
                    formData.oneTimeAmount = formData.amount;
                    
                    // Collect line items (already stored in lineItemsContainer as JSON)
                    const lineItemsJson = document.getElementById('lineItemsContainer').textContent;
                    const allLineItems = lineItemsJson ? JSON.parse(lineItemsJson) : [];
                    formData.allLineItems = allLineItems;
                    formData.lineItems = allLineItems.filter(item => !item.isSubscription);
                    
                    const subscriptionItemsJson = document.getElementById('subscriptionItemsContainer').textContent;
                    if (subscriptionItemsJson) {
                        try {
                            formData.subscriptionItems = JSON.parse(subscriptionItemsJson);
                        } catch (e) {
                            console.error('Error parsing subscription items JSON:', e);
                            formData.subscriptionItems = [];
                        }
                    } else {
                        formData.subscriptionItems = [];
                    }
                    
                    formData.subscriptionMonthlyTotal = formData.subscriptionItems.reduce((sum, item) => sum + (parseFloat(item.subtotal) || 0), 0).toFixed(2);
                    formData.hasSubscription = formData.subscriptionItems.length > 0;
                    formData.oneTimeLineItems = formData.lineItems;

                    // Add payment plan data if present
                    if (window.paymentPlanData) {
                        formData.isPaymentPlan = window.paymentPlanData.isPaymentPlan;
                        formData.paymentPlanInstallments = window.paymentPlanData.paymentPlanInstallments;
                        formData.paymentPlanTotalAmount = window.paymentPlanData.paymentPlanTotalAmount;
                        // Get quoteId from URL if present
                        const urlParams = new URLSearchParams(window.location.search);
                        formData.quoteId = urlParams.get('quoteId') || null;
                    }

                    console.log('Sending payment data to server:', {
                        ...formData,
                        cardNumber: cardNumber.substring(0, 4) + '****',
                        cardCode: '***'
                    });
                    
                    // Debug: Check each field individually
                    console.log('Field validation check:', {
                        cardNumber: !!formData.cardNumber,
                        expDate: !!formData.expDate,
                        cardCode: !!formData.cardCode,
                        firstName: !!formData.firstName,
                        lastName: !!formData.lastName,
                        address1: !!formData.address1,
                        city: !!formData.city,
                        state: !!formData.state,
                        zip: !!formData.zip,
                        email: !!formData.email,
                        billingFirstName: !!formData.billingFirstName,
                        billingLastName: !!formData.billingLastName,
                        billingAddress1: !!formData.billingAddress1,
                        billingCity: !!formData.billingCity,
                        billingState: !!formData.billingState,
                        billingZip: !!formData.billingZip,
                        amount: formData.amount !== undefined,
                        hasSubscription: formData.hasSubscription
                    });

                    // Send to our server-side API
                    const response = await fetch('/api/process-payment-server', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-vercel-protection-bypass': 'F9A72B1C8E5D4F0A6C3B7E2D9A8F5C1E'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    const raw = await response.text();
                    let result;
                    try {
                        result = JSON.parse(raw);
                    } catch (e) {
                        console.error('Non-JSON response:', raw);
                        throw new Error(raw?.slice(0, 200) || 'Server returned non-JSON response');
                    }
                    console.log('Payment response:', result);
                    console.log('Response type check:', {
                        success: result.success,
                        successType: typeof result.success,
                        transactionId: result.transactionId,
                        invoiceNumber: result.invoiceNumber,
                        hasError: !!result.error,
                        message: result.message,
                        debug: result.debug
                    });
                    
                    // Check for success - handle both boolean and string responses
                    const isSuccess = result.success === true || 
                                     result.success === 'true' || 
                                     (result.transactionId && !result.error);
                    
                    console.log('Is success?', isSuccess);
                    
                    if (isSuccess) {
                        // Payment successful - redirect immediately
                        console.log('Calling showSuccess with:', result);
                        showSuccess(result, formData);
                    } else {
                        // Payment failed
                        console.log('Calling showError with:', result.error || result.message);
                        showError(result.error || result.message || 'Payment failed. Please try again.');
                    }
                    
                } catch (error) {
                    console.error('Payment error:', error);
                    showError(error.message || 'Network error. Please check your connection and try again.');
                } finally {
                    // Reset button
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            });

            function showError(message) {
                // Remove any existing error messages
                const existingError = document.querySelector('.error-message');
                if (existingError) {
                    existingError.remove();
                }

                const messageContainer = document.getElementById('messageContainer');
                if (!messageContainer) {
                    console.error('Message container not found');
                    alert('Error: ' + message);
                    return;
                }
                
                messageContainer.classList.remove('hidden', 'bg-green-100', 'text-green-800');
                messageContainer.classList.add('bg-red-100', 'text-red-800', 'error-message');
                messageContainer.innerHTML = `<p class="font-semibold">Error:</p><p>${message}</p>`;
                messageContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            async function showSuccess(result, formPayload) {
                console.log('Payment successful, redirecting to success page:', result);

                try {
                    const storedPayload = {
                        transactionId: result.transactionId || null,
                        invoiceNumber: result.invoiceNumber || null,
                        authCode: result.authCode || null,
                        amount: result.amount || formPayload?.oneTimeAmount || document.getElementById('amount')?.value || null,
                        message: result.message || null,
                        hasSubscription: result.hasSubscription ?? formPayload?.hasSubscription ?? false,
                        subscriptionMonthlyTotal: result.subscriptionMonthlyTotal ?? formPayload?.subscriptionMonthlyTotal ?? null,
                        subscriptionResults: Array.isArray(result.subscriptionResults) ? result.subscriptionResults : [],
                        lineItems: Array.isArray(formPayload?.allLineItems) ? formPayload.allLineItems : Array.isArray(formPayload?.lineItems) ? formPayload.lineItems : [],
                        subscriptionItems: Array.isArray(formPayload?.subscriptionItems) ? formPayload.subscriptionItems : []
                    };
                    sessionStorage.setItem('paymentResult', JSON.stringify(storedPayload));
                } catch (storageError) {
                    console.warn('Unable to store payment result in sessionStorage:', storageError);
                }
                
                // In development/local mode, trigger direct sync (webhooks won't reach localhost)
                const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                if (isLocalDev && result.transactionId) {
                    try {
                        console.log('Local dev detected - triggering direct payment sync...');
                        
                        // Get customer info from form
                        const email = document.getElementById('email')?.value || formPayload?.email || '';
                        const firstName = document.getElementById('firstName')?.value || formPayload?.firstName || '';
                        const lastName = document.getElementById('lastName')?.value || formPayload?.lastName || '';
                        const amount = result.amount || formPayload?.oneTimeAmount || document.getElementById('amount')?.value || null;
                        const invoiceNumber = result.invoiceNumber || null;
                        
                        // Get line items
                        const lineItemsContainer = document.getElementById('lineItemsContainer');
                        let lineItems = [];
                        if (lineItemsContainer && lineItemsContainer.textContent) {
                            try {
                                lineItems = JSON.parse(lineItemsContainer.textContent);
                            } catch (e) {
                                console.warn('Could not parse line items:', e);
                            }
                        }
                        
                        // Call direct sync endpoint (non-blocking - don't wait for it)
                        fetch('/api/sync-payment-direct', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                transactionId: result.transactionId,
                                email: email,
                                amount: amount,
                                invoiceNumber: invoiceNumber,
                                firstName: firstName,
                                lastName: lastName,
                                lineItems: lineItems
                            })
                        }).then(response => response.json())
                          .then(syncResult => {
                              console.log('Direct payment sync result:', syncResult);
                              if (syncResult.success) {
                                  console.log('✅ Payment synced to GHL successfully (dev mode)');
                              } else {
                                  console.warn('⚠️ Direct sync skipped or failed:', syncResult.reason || syncResult.error);
                              }
                          })
                          .catch(error => {
                              console.error('Error calling direct sync endpoint:', error);
                              // Don't block redirect on sync error
                          });
                    } catch (syncError) {
                        console.error('Error triggering direct sync:', syncError);
                        // Don't block redirect on sync error
                    }
                }
                
                // Build success page URL with transaction details
                const successUrl = buildSuccessUrl(result);
                
                // Immediately redirect to success page (don't show message on this page)
                window.location.href = successUrl;
            }

            function buildSuccessUrl(result) {
                // Use absolute path for success page
                const baseUrl = '/payment-success.html';
                const params = new URLSearchParams();
                
                // Add transaction details (include "0" for test transactions)
                if (result.transactionId !== null && result.transactionId !== undefined && result.transactionId !== 'null') {
                    params.append('transactionId', result.transactionId);
                }
                if (result.invoiceNumber) params.append('invoiceNumber', result.invoiceNumber);
                
                // Log what we're passing to success page
                console.log('Success page parameters:', {
                    transactionId: result.transactionId,
                    invoiceNumber: result.invoiceNumber,
                    debug: result.debug
                });
                if (result.amount) params.append('amount', result.amount);
                if (result.message) params.append('message', result.message);
                if (result.authCode) params.append('authCode', result.authCode);
                
                // Add customer details from form
                const firstName = document.getElementById('firstName')?.value;
                const lastName = document.getElementById('lastName')?.value;
                const email = document.getElementById('email')?.value;
                
                if (firstName) params.append('firstName', firstName);
                if (lastName) params.append('lastName', lastName);
                if (email) params.append('email', email);
                
                // Add service details from lineItemsContainer (stored as JSON)
                const lineItemsJson = document.getElementById('lineItemsContainer')?.textContent;
                if (lineItemsJson) {
                    try {
                        const lineItems = JSON.parse(lineItemsJson);
                        lineItems.forEach((item, index) => {
                            if (item.name) params.append(`productName${index}`, item.name);
                            if (item.quantity) params.append(`quantity${index}`, item.quantity);
                            if (item.unitPrice) params.append(`unitPrice${index}`, item.unitPrice);
                            if (item.description) params.append(`description${index}`, item.description);
                        });
                    } catch (e) {
                        console.error('Error parsing line items for success page:', e);
                    }
                }
                
                const finalUrl = `${baseUrl}?${params.toString()}`;
                console.log('Success page URL:', finalUrl);
                return finalUrl;
            }

            function populateCustomerInfo(urlParams) {
                const customerFields = ['firstName', 'lastName', 'company', 'email', 'phone', 'city', 'state', 'zip'];
                customerFields.forEach(field => {
                    const element = document.getElementById(field);
                    if (element) {
                        element.value = urlParams.get(field) || '';
                    }
                });
                const secondaryEmailElement = document.getElementById('secondaryEmail');
                if (secondaryEmailElement) {
                    secondaryEmailElement.value = urlParams.get('secondaryEmail') || '';
                }
                // Handle address1 separately since the field ID is 'address' but URL param is 'address1'
                const addressElement = document.getElementById('address');
                if (addressElement) {
                    addressElement.value = urlParams.get('address1') || '';
                }
                const address2Element = document.getElementById('address2');
                if (address2Element) {
                    address2Element.value = urlParams.get('address2') || '';
                }
            }

            function copyShippingToBilling(force = false) {
                const copyCheckbox = document.getElementById('copyShippingToBilling');
                if (!copyCheckbox) return;
                if (!force && !copyCheckbox.checked) return;

                const mappings = {
                    firstName: 'billingFirstName',
                    lastName: 'billingLastName',
                    company: 'billingCompany',
                    address: 'billingAddress1',
                    address2: 'billingAddress2',
                    city: 'billingCity',
                    state: 'billingState',
                    zip: 'billingZip'
                };

                Object.entries(mappings).forEach(([shippingId, billingId]) => {
                    const source = document.getElementById(shippingId);
                    const target = document.getElementById(billingId);
                    if (source && target) {
                        target.value = source.value || '';
                    }
                });

                const billingCountry = document.getElementById('billingCountry');
                if (billingCountry && !billingCountry.value) {
                    billingCountry.value = 'US';
                }
            }

            function populateQuoteSummary(urlParams) {
                const quoteSummary = document.getElementById('quoteSummary');
                const dueTodayAmount = document.getElementById('dueTodayAmount');
                const subscriptionSummaryRow = document.getElementById('subscriptionSummaryRow');
                const subscriptionSummaryAmount = document.getElementById('subscriptionSummaryAmount');
                const amountInput = document.getElementById('amount');
                const lineItemsContainer = document.getElementById('lineItemsContainer'); // This will store JSON
                const subscriptionItemsContainer = document.getElementById('subscriptionItemsContainer');
                
                let oneTimeTotal = 0;
                let subscriptionTotal = 0;
                let serviceIndex = 0;
                let summaryHTML = '';
                const lineItems = []; // Array to hold line item objects
                const subscriptionItems = [];

                console.log('URL Params:', urlParams.toString());
                console.log('Checking for services...');

                while (urlParams.has(`productName${serviceIndex}`)) {
                    console.log(`Processing service ${serviceIndex}:`, {
                        serviceName: urlParams.get(`productName${serviceIndex}`),
                        quantity: urlParams.get(`quantity${serviceIndex}`),
                        description: urlParams.get(`description${serviceIndex}`),
                        unitCost: urlParams.get(`unitCost${serviceIndex}`),
                        subtotal: urlParams.get(`subtotal${serviceIndex}`)
                    });
                    const serviceName = urlParams.get(`productName${serviceIndex}`);
                    const quantity = urlParams.get(`quantity${serviceIndex}`);
                    const description = urlParams.get(`description${serviceIndex}`);
                    const unitCost = urlParams.get(`unitCost${serviceIndex}`);
                    const subtotal = urlParams.get(`subtotal${serviceIndex}`);
                    const isSubscription = urlParams.get(`isSubscription${serviceIndex}`) === 'true';
                    const subscriptionIntervalParam = urlParams.get(`subscriptionInterval${serviceIndex}`) || 'monthly';
                    const subscriptionStartDate = urlParams.get(`subscriptionStartDate${serviceIndex}`) || '';

                    if (serviceName && quantity && unitCost) {
                        const currentSubtotal = parseFloat(subtotal) || (parseFloat(quantity) * parseFloat(unitCost));
                        
                        if (isSubscription) {
                            subscriptionTotal += currentSubtotal;
                        } else {
                            oneTimeTotal += currentSubtotal;
                        }

                        summaryHTML += `
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium">
                                        ${serviceName} (x${quantity})
                                        ${isSubscription ? '<span class="ml-2 px-2 py-0.5 text-xs font-semibold rounded-full bg-purple-100 text-purple-700">Subscription</span>' : ''}
                                    </p>
                                    ${description ? `<p class="text-sm text-gray-500">${description}</p>` : ''}
                                </div>
                                <span class="font-semibold">$${currentSubtotal.toFixed(2)}</span>
                            </div>
                        `;

                        // Add to line items array for JSON
                        const quantityInt = Math.max(1, Math.floor(parseFloat(quantity) || 1));
                        const unitPriceNumber = Math.max(0.01, parseFloat(unitCost) || 0.01);

                        lineItems.push({
                            itemId: (serviceIndex + 1).toString(),
                            name: serviceName,
                            description: description || '',
                            quantity: quantityInt,
                            unitPrice: unitPriceNumber,
                            subtotal: currentSubtotal,
                            taxable: false, // Assuming not taxable for now
                            isSubscription: isSubscription,
                            subscriptionInterval: isSubscription ? subscriptionIntervalParam : null
                        });

                        if (isSubscription) {
                            subscriptionItems.push({
                                name: serviceName,
                                description: description || '',
                                quantity: quantityInt,
                                unitPrice: unitPriceNumber,
                                subtotal: currentSubtotal,
                                interval: subscriptionIntervalParam,
                                startDate: subscriptionStartDate
                            });
                        }
                    }
                    serviceIndex++;
                }

                console.log('Final summary:', {
                    totalServices: serviceIndex,
                    oneTimeTotal: oneTimeTotal.toFixed(2),
                    subscriptionTotal: subscriptionTotal.toFixed(2),
                    lineItemsCount: lineItems.length,
                    subscriptionItemsCount: subscriptionItems.length,
                    summaryHTML: summaryHTML
                });

                quoteSummary.innerHTML = summaryHTML;

                // Check for payment plan
                const isPaymentPlan = urlParams.get('isPaymentPlan') === 'true';
                const paymentPlanInstallments = parseInt(urlParams.get('paymentPlanInstallments')) || 3;
                const paymentPlanTotalAmount = parseFloat(urlParams.get('paymentPlanTotalAmount')) || oneTimeTotal;

                let amountToCharge = oneTimeTotal;

                if (isPaymentPlan && paymentPlanTotalAmount > 0) {
                    // Calculate payment plan amounts
                    const { firstPayment, recurringAmount } = calculatePaymentPlanAmounts(paymentPlanTotalAmount, paymentPlanInstallments);
                    amountToCharge = firstPayment;

                    // Show payment plan info
                    const paymentPlanInfo = document.getElementById('paymentPlanInfo');
                    if (paymentPlanInfo) {
                        paymentPlanInfo.classList.remove('hidden');
                    }

                    // Update payment plan display
                    const ppTotalAmount = document.getElementById('ppTotalAmount');
                    const ppInstallments = document.getElementById('ppInstallments');
                    const ppFirstPayment = document.getElementById('ppFirstPayment');
                    const ppRemainingCount = document.getElementById('ppRemainingCount');
                    const ppRemainingAmount = document.getElementById('ppRemainingAmount');

                    if (ppTotalAmount) ppTotalAmount.textContent = `$${paymentPlanTotalAmount.toFixed(2)}`;
                    if (ppInstallments) ppInstallments.textContent = paymentPlanInstallments;
                    if (ppFirstPayment) ppFirstPayment.textContent = `$${firstPayment.toFixed(2)}`;
                    if (ppRemainingCount) ppRemainingCount.textContent = paymentPlanInstallments - 1;
                    if (ppRemainingAmount) ppRemainingAmount.textContent = `$${recurringAmount.toFixed(2)}`;

                    console.log('Payment plan configured:', {
                        totalAmount: paymentPlanTotalAmount,
                        installments: paymentPlanInstallments,
                        firstPayment,
                        recurringAmount,
                        amountToCharge
                    });

                    // Store payment plan data for form submission
                    window.paymentPlanData = {
                        isPaymentPlan: true,
                        paymentPlanInstallments,
                        paymentPlanTotalAmount,
                        firstPayment,
                        recurringAmount
                    };
                }

                if (dueTodayAmount) {
                    dueTodayAmount.textContent = `$${amountToCharge.toFixed(2)}`;
                }
                if (subscriptionSummaryAmount) {
                    subscriptionSummaryAmount.textContent = `$${subscriptionTotal.toFixed(2)}`;
                }
                if (subscriptionSummaryRow) {
                    if (subscriptionTotal > 0) {
                        subscriptionSummaryRow.classList.remove('hidden');
                    } else {
                        subscriptionSummaryRow.classList.add('hidden');
                    }
                }

                if (amountInput) {
                    amountInput.value = amountToCharge.toFixed(2);
                }

                // Store line items as JSON in the hidden container
                lineItemsContainer.textContent = JSON.stringify(lineItems);
                if (subscriptionItemsContainer) {
                    subscriptionItemsContainer.textContent = JSON.stringify(subscriptionItems);
                }
            }

            // Payment plan amount calculation (same logic as quote-tool)
            function calculatePaymentPlanAmounts(totalAmount, installments) {
                if (!totalAmount || totalAmount <= 0 || !installments || installments < 2) {
                    return { firstPayment: 0, recurringAmount: 0 };
                }

                const baseAmount = Math.floor((totalAmount * 100) / installments) / 100;
                const sumOfBaseAmounts = baseAmount * installments;
                const remainder = Math.round((totalAmount - sumOfBaseAmounts) * 100) / 100;
                const firstPayment = Math.round((baseAmount + remainder) * 100) / 100;

                return { firstPayment, recurringAmount: baseAmount };
            }
        });
    </script>
</body>
</html>

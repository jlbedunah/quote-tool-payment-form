<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - User Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#fef2f2',
                            500: '#CA1824',
                            600: '#B0151F',
                            700: '#96121A',
                        },
                        brand: '#CA1824'
                    }
                }
            }
        }
    </script>
    <!-- Navigation Menu -->
    <script type="module" src="/lib/navigation-menu.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md mb-6 p-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">User Management</h1>
                    <p class="text-gray-600 mt-1">Manage users and their access</p>
                </div>
                <button onclick="openAddUserModal()" 
                        class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg transition-colors duration-200 font-medium flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Add User
                </button>
            </div>
        </div>

        <!-- Users Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading users...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4" id="modalTitle">Add User</h3>
                <form id="userForm" class="space-y-4">
                    <div>
                        <label for="userFirstName" class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                        <input type="text" id="userFirstName" name="firstName" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="userLastName" class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                        <input type="text" id="userLastName" name="lastName" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="userEmail" class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                        <input type="email" id="userEmail" name="email" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="userPassword" class="block text-sm font-medium text-gray-700 mb-2">
                            Password <span id="passwordRequired" class="text-red-500">*</span>
                            <span id="passwordOptional" class="text-gray-500 text-xs">(leave blank to keep current)</span>
                        </label>
                        <input type="password" id="userPassword" name="password"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="userIsAdmin" name="isAdmin"
                                   class="mr-2 h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                            <span class="text-sm text-gray-700">Admin User</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="userIsActive" name="isActive" checked
                                   class="mr-2 h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                            <span class="text-sm text-gray-700">Active</span>
                        </label>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeUserModal()"
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" id="saveUserBtn"
                                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                            Save User
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let users = [];
        let editingUserId = null;

        // Load users on page load
        window.addEventListener('load', async function() {
            // Initialize navigation menu with authentication check
            try {
                const { initNavigationWithAuth } = await import('/lib/navigation-menu.js');
                const user = await initNavigationWithAuth();
                
                // Check if user is admin (admin pages require admin access)
                if (!user || !user.is_admin) {
                    alert('Access denied. Admin privileges required.');
                    window.location.href = '/quote-tool.html';
                    return;
                }
            } catch (error) {
                console.error('Error initializing navigation:', error);
                // If navigation fails, redirect to login
                window.location.href = '/login.html';
                return;
            }
            
            loadUsers();
        });

        // Load users from API
        async function loadUsers() {
            try {
                const accessToken = localStorage.getItem('supabase_access_token');
                const response = await fetch('/api/users', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    users = data.users || [];
                    renderUsers();
                } else {
                    showError(data.error || 'Failed to load users');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showError('Error loading users: ' + error.message);
            }
        }

        // Render users table
        function renderUsers() {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                const roleBadge = user.is_admin 
                    ? '<span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded">Admin</span>'
                    : '<span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded">User</span>';
                
                const statusBadge = user.is_active
                    ? '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded">Active</span>'
                    : '<span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded">Inactive</span>';

                const createdDate = user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.first_name} ${user.last_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${roleBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${statusBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${createdDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editUser('${user.id}')" class="text-red-600 hover:text-red-900 mr-3">Edit</button>
                            <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Open add user modal
        function openAddUserModal() {
            editingUserId = null;
            document.getElementById('modalTitle').textContent = 'Add User';
            document.getElementById('userForm').reset();
            document.getElementById('userPassword').required = true;
            document.getElementById('passwordRequired').classList.remove('hidden');
            document.getElementById('passwordOptional').classList.add('hidden');
            document.getElementById('userIsActive').checked = true;
            document.getElementById('userModal').classList.remove('hidden');
        }

        // Edit user
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            editingUserId = userId;
            document.getElementById('modalTitle').textContent = 'Edit User';
            document.getElementById('userFirstName').value = user.first_name || '';
            document.getElementById('userLastName').value = user.last_name || '';
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').required = false;
            document.getElementById('passwordRequired').classList.add('hidden');
            document.getElementById('passwordOptional').classList.remove('hidden');
            document.getElementById('userIsAdmin').checked = user.is_admin || false;
            document.getElementById('userIsActive').checked = user.is_active !== false;
            document.getElementById('userModal').classList.remove('hidden');
        }

        // Close user modal
        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
            editingUserId = null;
        }

        // Save user
        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const userData = {
                first_name: formData.get('firstName'),
                last_name: formData.get('lastName'),
                email: formData.get('email'),
                password: formData.get('password') || null,
                is_admin: formData.get('isAdmin') === 'on',
                is_active: formData.get('isActive') === 'on'
            };

            try {
                const accessToken = localStorage.getItem('supabase_access_token');
                const url = editingUserId ? `/api/users/${editingUserId}` : '/api/users';
                const method = editingUserId ? 'PUT' : 'POST';

                const saveBtn = document.getElementById('saveUserBtn');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    closeUserModal();
                    loadUsers();
                    showSuccess(editingUserId ? 'User updated successfully' : 'User created successfully');
                } else {
                    showError(data.error || 'Failed to save user');
                }
            } catch (error) {
                console.error('Error saving user:', error);
                showError('Error saving user: ' + error.message);
            } finally {
                const saveBtn = document.getElementById('saveUserBtn');
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save User';
            }
        });

        // Delete user
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) {
                return;
            }

            try {
                const accessToken = localStorage.getItem('supabase_access_token');
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    loadUsers();
                    showSuccess('User deleted successfully');
                } else {
                    showError(data.error || 'Failed to delete user');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showError('Error deleting user: ' + error.message);
            }
        }

        // Show success message
        function showSuccess(message) {
            alert(message);
        }

        // Show error message
        function showError(message) {
            alert('Error: ' + message);
        }
    </script>
</body>
</html>


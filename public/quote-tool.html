<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quote Tool</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8ZN40WHZ74"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-8ZN40WHZ74');
    </script>
    
    <!-- Hyros Tracking Script -->
    <script>
    var head = document.head;
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = "https://t.mybookkeepers.com/v1/lst/universal-script?ph=cfa99e7cf0bfaa3f377a76c9efca19d672fdc7eab55b71a9f40e80623231ee9d&tag=!clicked&ref_url=" + encodeURI(document.URL) ;
    head.appendChild(script);
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#fef2f2',
                            500: '#CA1824',
                            600: '#B0151F',
                            700: '#96121A',
                        },
                        brand: '#CA1824'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
    <div class="max-w-6xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-white rounded-t-xl shadow-lg border-b border-gray-200">
            <div class="bg-gradient-to-r from-red-600 to-red-700 text-white p-8 rounded-t-xl" style="background: linear-gradient(135deg, #CA1824 0%, #B0151F 100%);">
                <div class="text-center">
                    <!-- Logo -->
                    <div class="flex justify-center items-center mb-4">
                        <div class="flex items-center bg-white rounded-lg px-4 py-2 shadow-lg">
                            <!-- Red checkmark icon -->
                            <div class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center mr-3">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <!-- Logo text -->
                            <div class="text-left">
                                <div class="text-lg font-bold">
                                    <span class="text-black">My</span>
                                    <span class="text-red-600" style="color: #CA1824;">Bookkeepers.com</span>
                                </div>
                                <div class="text-xs text-gray-600 font-medium">Passionate About Bookkeeping</div>
                            </div>
                        </div>
                    </div>
                    <h1 class="text-4xl font-bold mb-2">Quote Tool</h1>
                    <p class="text-gray-300 text-lg">Create professional quotes with ease</p>
                </div>
            </div>
        </div>

        <form id="quoteForm" class="bg-white rounded-b-xl shadow-lg overflow-hidden">
            <!-- Customer Information Section -->
            <div class="p-8 border-b border-gray-200">
                <div class="flex items-center mb-6">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-semibold text-gray-800">Customer Information</h2>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="firstName" class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                        <input type="text" id="firstName" name="firstName" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="lastName" class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                        <input type="text" id="lastName" name="lastName" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label for="companyName" class="block text-sm font-medium text-gray-700 mb-2">Company Name</label>
                        <input type="text" id="companyName" name="companyName" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                        <input type="email" id="email" name="email" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                </div>

                <div class="mt-6">
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Phone *</label>
                    <input type="tel" id="phone" name="phone" required 
                           class="w-full md:w-1/2 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                </div>

                <div class="mt-6">
                    <label for="address1" class="block text-sm font-medium text-gray-700 mb-2">Address Line 1 *</label>
                    <input type="text" id="address1" name="address1" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                </div>

                <div class="mt-6">
                    <label for="address2" class="block text-sm font-medium text-gray-700 mb-2">Address Line 2</label>
                    <input type="text" id="address2" name="address2" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                    <div>
                        <label for="city" class="block text-sm font-medium text-gray-700 mb-2">City *</label>
                        <input type="text" id="city" name="city" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="state" class="block text-sm font-medium text-gray-700 mb-2">State *</label>
                        <input type="text" id="state" name="state" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="zip" class="block text-sm font-medium text-gray-700 mb-2">ZIP Code *</label>
                        <input type="text" id="zip" name="zip" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                </div>
            </div>

            <!-- Service Details Section -->
            <div class="p-8 border-b border-gray-200">
                <div class="flex items-center mb-6">
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-semibold text-gray-800">Service Details</h2>
                </div>
                
                <div id="serviceRows">
                    <div class="service-row bg-gray-50 rounded-lg p-6 mb-4" data-row="0">
                        <div class="grid grid-cols-1 lg:grid-cols-6 gap-4 items-end">
                            <div class="lg:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Service Name *</label>
                                <div class="relative">
                                    <input type="text" name="productName0" id="serviceInput0" required 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                           autocomplete="off" placeholder="Type to search services...">
                                    <div id="serviceDropdown0" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-60 overflow-y-auto">
                                        <div class="p-2">
                                            <div class="service-option px-3 py-2 hover:bg-blue-50 cursor-pointer rounded" data-value="Catch-up Bookkeeping" data-price="2.19" data-subscription="false" data-interval="">
                                                <div class="font-medium">Catch-up Bookkeeping</div>
                                                <div class="text-sm text-gray-500">$2.19</div>
                                            </div>
                                            <div class="service-option px-3 py-2 hover:bg-blue-50 cursor-pointer rounded" data-value="Tax Return (LLC)" data-price="1.99" data-subscription="false" data-interval="">
                                                <div class="font-medium">Tax Return (LLC)</div>
                                                <div class="text-sm text-gray-500">$1.99</div>
                                            </div>
                                            <div class="service-option px-3 py-2 hover:bg-blue-50 cursor-pointer rounded" data-value="Tax Return (S-Corp)" data-price="2.01" data-subscription="false" data-interval="">
                                                <div class="font-medium">Tax Return (S-Corp)</div>
                                                <div class="text-sm text-gray-500">$2.01</div>
                                            </div>
                                            <div class="service-option px-3 py-2 hover:bg-blue-50 cursor-pointer rounded" data-value="Monthly Bookkeeping Subscription" data-price="2.19" data-subscription="true" data-interval="monthly">
                                                <div class="font-medium">Monthly Bookkeeping Subscription</div>
                                                <div class="text-sm text-gray-500">$2.19</div>
                                            </div>
                                            <div class="border-t border-gray-200 mt-2 pt-2">
                                                <div class="add-service-option px-3 py-2 hover:bg-green-50 cursor-pointer rounded text-green-600 font-medium">
                                                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                    </svg>
                                                    Add "<span class="add-service-text"></span>" as new service
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Quantity *</label>
                                <input type="number" name="quantity0" min="1" step="1" required onchange="calculateSubtotal(0)"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                            </div>
                            <div class="lg:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea name="description0" rows="2" 
                                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 h-[52px] resize-y"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Unit Cost *</label>
                                <input type="number" name="unitCost0" min="0" step="0.01" required onchange="calculateSubtotal(0)"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-6 gap-4 mt-4 items-end">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Subtotal</label>
                                <input type="text" name="subtotal0" readonly 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700 font-semibold">
                            </div>
                            <div class="lg:col-span-3">
                                <input type="hidden" name="isSubscription0" value="false">
                                <input type="hidden" name="subscriptionInterval0" value="monthly">
                                <div class="subscription-info hidden px-4 py-3 border border-purple-200 bg-purple-50 rounded-lg">
                                    <p class="text-sm text-purple-700 font-semibold">
                                        This service will be billed <span class="subscription-interval-text">monthly</span>.
                                    </p>
                                </div>
                            </div>
                            <div class="lg:col-span-2">
                                <button type="button" class="remove-row-btn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors duration-200 font-medium" 
                                        onclick="removeRow(0)" style="display: none;">
                                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                    Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" class="add-row-btn text-white px-6 py-3 rounded-lg transition-all duration-200 font-medium flex items-center mx-auto" 
                        style="background-color: #CA1824;" 
                        onmouseover="this.style.backgroundColor='#B0151F'" 
                        onmouseout="this.style.backgroundColor='#CA1824'"
                        onclick="addServiceRow()">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Add Another Service
                </button>
            </div>

            <!-- Total Section -->
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-8 border-b border-gray-200">
                <div class="text-right space-y-2">
                    <div class="text-2xl font-bold text-gray-800">
                        Due Today: $<span id="oneTimeTotal" style="color: #CA1824;">0.00</span>
                    </div>
                    <div id="subscriptionTotalRow" class="text-sm text-gray-700 hidden">
                        Monthly Subscription: <span class="font-semibold">$<span id="subscriptionTotal">0.00</span></span>
                    </div>
                    <div class="text-sm text-gray-500">
                        Combined Quote Value (one-time + first month): $<span id="grandTotal">0.00</span>
                    </div>
                </div>
                <input type="hidden" id="oneTimeTotalInput" name="oneTimeTotal" value="0.00">
                <input type="hidden" id="subscriptionTotalInput" name="subscriptionMonthlyTotal" value="0.00">
            </div>

            <!-- Action Buttons Section -->
            <div class="p-8 bg-gray-50">
                <div class="text-center space-y-4">
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button type="button" class="build-link-btn text-white px-8 py-4 rounded-lg transition-all duration-200 font-semibold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1" 
                                style="background-color: #CA1824;" 
                                onmouseover="this.style.backgroundColor='#B0151F'" 
                                onmouseout="this.style.backgroundColor='#CA1824'"
                                onclick="buildLink()">
                            <svg class="w-6 h-6 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                            Pay Now
                        </button>
                        
                        <button type="button" class="email-quote-btn bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-lg transition-all duration-200 font-semibold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1" 
                                onclick="openEmailModal()">
                            <svg class="w-6 h-6 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            Send Quote via Email
                        </button>
                    </div>
                    <p class="text-sm text-gray-500">
                        You'll be redirected to the payment form
                    </p>
                </div>
            </div>
        </form>
    </div>

    <!-- Email Modal -->
    <div id="emailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Send Quote via Email</h3>
                    <button type="button" onclick="closeEmailModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <form id="emailForm">
                    <div class="mb-4">
                        <label for="recipientEmail" class="block text-sm font-medium text-gray-700 mb-2">
                            Recipient Email Address *
                        </label>
                        <input type="email" id="recipientEmail" name="recipientEmail" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="customer@example.com">
                    </div>
                    
                    <div class="mb-4">
                        <label for="emailSubject" class="block text-sm font-medium text-gray-700 mb-2">
                            Subject Line
                        </label>
                        <input type="text" id="emailSubject" name="emailSubject"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="Your Quote Request" value="Your Quote Request">
                    </div>
                    
                    <div class="mb-6">
                        <label for="emailMessage" class="block text-sm font-medium text-gray-700 mb-2">
                            Additional Message (Optional)
                        </label>
                        <textarea id="emailMessage" name="emailMessage" rows="3"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                  placeholder="Add any additional notes or instructions..."></textarea>
                    </div>
                    
                    <div class="flex gap-3">
                        <button type="button" onclick="closeEmailModal()"
                                class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" id="sendEmailBtn"
                                class="flex-1 px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                            <span id="sendEmailText">Send Quote</span>
                            <span id="sendEmailLoading" class="hidden">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Sending...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let rowCount = 1;

        function formatIntervalLabel(interval) {
            if (!interval) return 'monthly';
            const normalized = String(interval).toLowerCase();
            switch (normalized) {
                case 'monthly':
                    return 'monthly';
                case 'quarterly':
                    return 'quarterly';
                case 'weekly':
                    return 'weekly';
                case 'biweekly':
                case 'bi-weekly':
                    return 'bi-weekly';
                case 'annually':
                case 'annual':
                case 'yearly':
                    return 'annually';
                default:
                    return normalized;
            }
        }

        function setSubscriptionState(rowIndex, isSubscription, interval) {
            const row = document.querySelector(`[data-row="${rowIndex}"]`);
            if (!row) return;

            const flagInput = row.querySelector(`input[name="isSubscription${rowIndex}"]`);
            const intervalInput = row.querySelector(`input[name="subscriptionInterval${rowIndex}"]`);
            const infoBox = row.querySelector('.subscription-info');
            const infoText = row.querySelector('.subscription-interval-text');
        const quantityInput = row.querySelector(`input[name="quantity${rowIndex}"]`);
        const subtotalInput = row.querySelector(`input[name="subtotal${rowIndex}"]`);

            if (flagInput) {
                flagInput.value = isSubscription ? 'true' : 'false';
            }

            if (intervalInput) {
                if (interval) {
                    intervalInput.value = interval;
                }
                if (!intervalInput.value) {
                    intervalInput.value = 'monthly';
                }
            }

            if (infoBox) {
                if (isSubscription) {
                    const label = formatIntervalLabel(intervalInput ? intervalInput.value : interval);
                    if (infoText) {
                        infoText.textContent = label || 'monthly';
                    }
                    infoBox.classList.remove('hidden');
                } else {
                    infoBox.classList.add('hidden');
                }
            }

        if (quantityInput) {
            if (isSubscription) {
                const previous = quantityInput.value;
                if (previous !== '1') {
                    quantityInput.value = '1';
                }
                quantityInput.disabled = true;
                quantityInput.classList.add('bg-gray-100', 'cursor-not-allowed', 'opacity-75');
            } else {
                quantityInput.disabled = false;
                quantityInput.classList.remove('bg-gray-100', 'cursor-not-allowed', 'opacity-75');
            }
        }

        if (isSubscription && quantityInput && subtotalInput) {
            calculateSubtotal(rowIndex);
        } else {
            calculateGrandTotal();
        }
    }

    function handleCustomServiceSelection(rowIndex) {
        setSubscriptionState(rowIndex, false);
        }

        function addServiceRow() {
            const serviceRows = document.getElementById('serviceRows');
            const newRow = document.createElement('div');
            newRow.className = 'service-row bg-gray-50 rounded-lg p-6 mb-4';
            newRow.setAttribute('data-row', rowCount);
            
            newRow.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-6 gap-4 items-end">
                    <div class="lg:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Service Name *</label>
                        <div class="relative">
                            <input type="text" name="productName${rowCount}" id="serviceInput${rowCount}" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                   autocomplete="off" placeholder="Type to search services...">
                            <div id="serviceDropdown${rowCount}" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-60 overflow-y-auto">
                                <div class="p-2">
                                            <div class="service-option px-3 py-2 hover:bg-blue-50 cursor-pointer rounded" data-value="Catch-up Bookkeeping" data-price="2.19" data-subscription="false" data-interval="">
                                                <div class="font-medium">Catch-up Bookkeeping</div>
                                                <div class="text-sm text-gray-500">$2.19</div>
                                            </div>
                                            <div class="service-option px-3 py-2 hover:bg-blue-50 cursor-pointer rounded" data-value="Tax Return (LLC)" data-price="1.99" data-subscription="false" data-interval="">
                                                <div class="font-medium">Tax Return (LLC)</div>
                                                <div class="text-sm text-gray-500">$1.99</div>
                                            </div>
                                            <div class="service-option px-3 py-2 hover:bg-blue-50 cursor-pointer rounded" data-value="Tax Return (S-Corp)" data-price="2.01" data-subscription="false" data-interval="">
                                                <div class="font-medium">Tax Return (S-Corp)</div>
                                                <div class="text-sm text-gray-500">$2.01</div>
                                            </div>
                                            <div class="service-option px-3 py-2 hover:bg-blue-50 cursor-pointer rounded" data-value="Monthly Bookkeeping Subscription" data-price="2.19" data-subscription="true" data-interval="monthly">
                                                <div class="font-medium">Monthly Bookkeeping Subscription</div>
                                                <div class="text-sm text-gray-500">$2.19</div>
                                            </div>
                                    <div class="border-t border-gray-200 mt-2 pt-2">
                                        <div class="add-service-option px-3 py-2 hover:bg-green-50 cursor-pointer rounded text-green-600 font-medium">
                                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                            Add "<span class="add-service-text"></span>" as new service
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quantity *</label>
                        <input type="number" name="quantity${rowCount}" min="1" step="1" required onchange="calculateSubtotal(${rowCount})"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div class="lg:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea name="description${rowCount}" rows="2" 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 h-[52px] resize-y"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Unit Cost *</label>
                        <input type="number" name="unitCost${rowCount}" min="0" step="0.01" required onchange="calculateSubtotal(${rowCount})"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-6 gap-4 mt-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Subtotal</label>
                        <input type="text" name="subtotal${rowCount}" readonly 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700 font-semibold">
                    </div>
                    <div class="lg:col-span-3">
                        <input type="hidden" name="isSubscription${rowCount}" value="false">
                        <input type="hidden" name="subscriptionInterval${rowCount}" value="monthly">
                        <div class="subscription-info hidden px-4 py-3 border border-purple-200 bg-purple-50 rounded-lg">
                            <p class="text-sm text-purple-700 font-semibold">
                                This service will be billed <span class="subscription-interval-text">monthly</span>.
                            </p>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <button type="button" class="remove-row-btn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors duration-200 font-medium" 
                                onclick="removeRow(${rowCount})">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Remove
                        </button>
                    </div>
                </div>
            `;
            
            serviceRows.appendChild(newRow);
            rowCount++;
            
            // Show remove buttons for all rows if there's more than one
            updateRemoveButtons();
            
            // Initialize dropdown functionality for the new row
            initializeServiceDropdown(rowCount - 1);
            setSubscriptionState(rowCount - 1, false);
        }

        function removeRow(rowIndex) {
            const row = document.querySelector(`[data-row="${rowIndex}"]`);
            if (row) {
                row.remove();
                updateRemoveButtons();
                calculateGrandTotal();
            }
        }

        function updateRemoveButtons() {
            const rows = document.querySelectorAll('.service-row');
            rows.forEach((row, index) => {
                const removeBtn = row.querySelector('.remove-row-btn');
                if (rows.length > 1) {
                    removeBtn.style.display = 'block';
                } else {
                    removeBtn.style.display = 'none';
                }
            });
        }

        function calculateSubtotal(rowIndex) {
            const quantity = parseFloat(document.querySelector(`[name="quantity${rowIndex}"]`).value) || 0;
            const unitCost = parseFloat(document.querySelector(`[name="unitCost${rowIndex}"]`).value) || 0;
            const subtotal = quantity * unitCost;
            
            document.querySelector(`[name="subtotal${rowIndex}"]`).value = subtotal.toFixed(2);
            calculateGrandTotal();
        }

        function calculateGrandTotal() {
            let oneTimeTotal = 0;
            let subscriptionTotal = 0;
            
            const rows = document.querySelectorAll('.service-row');
            rows.forEach(row => {
                const subtotalInput = row.querySelector('input[name^="subtotal"]');
                if (!subtotalInput) return;
                const subtotal = parseFloat(subtotalInput.value) || 0;
                const rowIndex = row.getAttribute('data-row');
                const flagInput = rowIndex !== null ? row.querySelector(`input[name="isSubscription${rowIndex}"]`) : null;
                const isSubscription = flagInput ? flagInput.value === 'true' : false;
                
                if (isSubscription) {
                    subscriptionTotal += subtotal;
                } else {
                    oneTimeTotal += subtotal;
                }
            });
            
            const grandTotal = oneTimeTotal + subscriptionTotal;
            
            const oneTimeDisplay = document.getElementById('oneTimeTotal');
            const subscriptionDisplay = document.getElementById('subscriptionTotal');
            const grandTotalDisplay = document.getElementById('grandTotal');
            const subscriptionRow = document.getElementById('subscriptionTotalRow');
            const oneTimeInput = document.getElementById('oneTimeTotalInput');
            const subscriptionInput = document.getElementById('subscriptionTotalInput');
            
            if (oneTimeDisplay) oneTimeDisplay.textContent = oneTimeTotal.toFixed(2);
            if (subscriptionDisplay) subscriptionDisplay.textContent = subscriptionTotal.toFixed(2);
            if (grandTotalDisplay) grandTotalDisplay.textContent = grandTotal.toFixed(2);
            if (oneTimeInput) oneTimeInput.value = oneTimeTotal.toFixed(2);
            if (subscriptionInput) subscriptionInput.value = subscriptionTotal.toFixed(2);
            
            if (subscriptionRow) {
                if (subscriptionTotal > 0) {
                    subscriptionRow.classList.remove('hidden');
                } else {
                    subscriptionRow.classList.add('hidden');
                }
            }
        }

        function buildLink() {
            const form = document.getElementById('quoteForm');
            const formData = new FormData(form);
            const params = new URLSearchParams();
            
            // Add customer information
            const customerFields = ['firstName', 'lastName', 'companyName', 'email', 'phone', 'address1', 'address2', 'city', 'state', 'zip'];
            const totalsFields = ['oneTimeTotal', 'subscriptionMonthlyTotal'];
            customerFields.forEach(field => {
                const value = formData.get(field);
                if (value) {
                    params.append(field, value);
                }
            });
            totalsFields.forEach(field => {
                const value = formData.get(field);
                if (value !== null && value !== undefined) {
                    params.append(field, value);
                }
            });
            
            // Add service details
            const rows = document.querySelectorAll('.service-row');
            rows.forEach((row, index) => {
                const rowData = row.querySelectorAll('input, textarea');
                const rowIndexAttr = row.getAttribute('data-row');
                rowData.forEach(input => {
                    if (input.type === 'hidden') {
                        if (input.name.startsWith('isSubscription')) {
                            if (input.value === 'true') {
                                params.append(input.name, 'true');
                            }
                        } else if (input.name.startsWith('subscriptionInterval')) {
                            const flag = rowIndexAttr !== null ? row.querySelector(`input[name="isSubscription${rowIndexAttr}"]`) : null;
                            if (flag && flag.value === 'true' && input.value) {
                                params.append(input.name, input.value);
                            }
                        } else if (input.value) {
                            params.append(input.name, input.value);
                        }
                    } else if (input.value) {
                        params.append(input.name, input.value);
                    }
                });
            });
            
            // Generate the URL - ensure it points to payment-form-robust.html
            let baseUrl;
            if (window.location.pathname.includes('quote-tool.html')) {
                baseUrl = window.location.origin + window.location.pathname.replace('quote-tool.html', 'payment-form-robust.html');
            } else {
                // If running from root or other path, construct payment form URL
                baseUrl = window.location.origin + '/payment-form-robust.html';
            }
            const fullUrl = baseUrl + '?' + params.toString();
            
            // Copy to clipboard and redirect
            navigator.clipboard.writeText(fullUrl).then(() => {
                // Show success message
                const buildBtn = document.querySelector('.build-link-btn');
                const originalText = buildBtn.innerHTML;
                buildBtn.innerHTML = `
                    <svg class="w-6 h-6 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Redirecting...
                `;
                buildBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                buildBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                
                // Redirect after a short delay
                setTimeout(() => {
                    window.location.href = fullUrl;
                }, 1500);
                
            }).catch(err => {
                console.error('Failed to copy: ', err);
                // If clipboard fails, just redirect
                alert('Link generated! Redirecting to payment form...');
                setTimeout(() => {
                    window.location.href = fullUrl;
                }, 1000);
            });
        }

        function copyToClipboard() {
            const urlDiv = document.getElementById('generatedUrl');
            const url = urlDiv.textContent;
            
            navigator.clipboard.writeText(url).then(() => {
                const copyBtn = document.querySelector('.copy-btn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                copyBtn.className = 'copy-btn bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-colors duration-200 font-medium mt-4';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.className = 'copy-btn bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors duration-200 font-medium mt-4';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy to clipboard');
            });
        }

        // Service dropdown functionality
        function initializeServiceDropdown(rowIndex) {
            const input = document.getElementById(`serviceInput${rowIndex}`);
            const dropdown = document.getElementById(`serviceDropdown${rowIndex}`);
            const addServiceText = dropdown.querySelector('.add-service-text');
            
            if (!input || !dropdown) return;
            
            // Show dropdown on focus
            input.addEventListener('focus', function() {
                dropdown.classList.remove('hidden');
                filterServices(rowIndex);
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
            
            // Filter services as user types
            input.addEventListener('input', function() {
                filterServices(rowIndex);
                handleCustomServiceSelection(rowIndex);
            });
            
            // Handle service option clicks
            dropdown.addEventListener('click', function(e) {
                const serviceOption = e.target.closest('.service-option');
                
                if (serviceOption) {
                    const value = serviceOption.getAttribute('data-value') || '';
                    const price = serviceOption.getAttribute('data-price');
                    const isSubscription = serviceOption.getAttribute('data-subscription') === 'true';
                    const interval = serviceOption.getAttribute('data-interval') || undefined;
                    
                    input.value = value;
                    dropdown.classList.add('hidden');
                    
                    const serviceRow = input.closest('.service-row');
                    if (serviceRow && price) {
                        const unitCostInput = serviceRow.querySelector(`input[name="unitCost${rowIndex}"]`);
                        if (unitCostInput) {
                            unitCostInput.value = price;
                        }
                    }
                    
                    setSubscriptionState(rowIndex, isSubscription, interval);
                    
                    if (price) {
                        calculateSubtotal(rowIndex);
                    } else {
                        calculateGrandTotal();
                    }
                } else if (e.target.closest('.add-service-option')) {
                    const customValue = input.value.trim();
                    if (customValue) {
                        input.value = customValue;
                        dropdown.classList.add('hidden');
                        handleCustomServiceSelection(rowIndex);
                    }
                }
            });
        }
        
        function filterServices(rowIndex) {
            const input = document.getElementById(`serviceInput${rowIndex}`);
            const dropdown = document.getElementById(`serviceDropdown${rowIndex}`);
            const addServiceText = dropdown.querySelector('.add-service-text');
            const addServiceOption = dropdown.querySelector('.add-service-option');
            
            if (!input || !dropdown) return;
            
            const searchTerm = input.value.toLowerCase();
            const serviceOptions = dropdown.querySelectorAll('.service-option');
            let hasMatches = false;
            
            // Filter existing services
            serviceOptions.forEach(option => {
                const serviceNameElement = option.querySelector('.font-medium');
                const serviceName = serviceNameElement ? serviceNameElement.textContent.toLowerCase() : option.textContent.toLowerCase();
                if (serviceName.includes(searchTerm)) {
                    option.style.display = 'block';
                    hasMatches = true;
                } else {
                    option.style.display = 'none';
                }
            });
            
            // Show/hide add new service option
            if (searchTerm && !hasMatches) {
                addServiceText.textContent = input.value;
                addServiceOption.style.display = 'block';
            } else {
                addServiceOption.style.display = 'none';
            }
        }
        
        // Initialize dropdown for the first row
        function initializeAllDropdowns() {
            const rows = document.querySelectorAll('.service-row');
            rows.forEach((row, index) => {
                initializeServiceDropdown(index);
            });
        }

        // Load data from URL parameters on page load
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.toString()) {
                // Populate customer information
                const customerFields = ['firstName', 'lastName', 'companyName', 'email', 'phone', 'address1', 'address2', 'city', 'state', 'zip'];
                customerFields.forEach(field => {
                    const value = urlParams.get(field);
                    if (value) {
                        document.getElementById(field).value = value;
                    }
                });
                
                // Populate service details
                let serviceIndex = 0;
                while (urlParams.has(`productName${serviceIndex}`)) {
                    if (serviceIndex > 0) {
                        addServiceRow();
                    }
                    
                    const serviceFields = ['productName', 'quantity', 'description', 'unitCost', 'subtotal'];
                    serviceFields.forEach(field => {
                        const value = urlParams.get(`${field}${serviceIndex}`);
                        if (value) {
                            const input = document.querySelector(`[name="${field}${serviceIndex}"]`);
                            if (input) {
                                input.value = value;
                            }
                        }
                    });
                    
                    const isSubscriptionParam = urlParams.get(`isSubscription${serviceIndex}`) === 'true';
                    const intervalParam = urlParams.get(`subscriptionInterval${serviceIndex}`) || undefined;
                    setSubscriptionState(serviceIndex, isSubscriptionParam, intervalParam);
                    
                    serviceIndex++;
                }
                
                // Calculate totals
                calculateGrandTotal();
            }
            
            // Initialize all service dropdowns
            initializeAllDropdowns();
            calculateGrandTotal();
        });

        // Email functionality
        function openEmailModal() {
            document.getElementById('emailModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Pre-fill recipient email if customer email is available
            const customerEmail = document.getElementById('email').value;
            if (customerEmail) {
                document.getElementById('recipientEmail').value = customerEmail;
            }
        }

        function closeEmailModal() {
            document.getElementById('emailModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            
            // Reset form
            document.getElementById('emailForm').reset();
            if (document.getElementById('email').value) {
                document.getElementById('recipientEmail').value = document.getElementById('email').value;
            }
        }

        // Handle email form submission
        document.getElementById('emailForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const sendBtn = document.getElementById('sendEmailBtn');
            const sendText = document.getElementById('sendEmailText');
            const sendLoading = document.getElementById('sendEmailLoading');
            
            // Show loading state
            sendText.classList.add('hidden');
            sendLoading.classList.remove('hidden');
            sendBtn.disabled = true;
            
            try {
                // Collect form data
                const formData = new FormData(document.getElementById('quoteForm'));
                const emailData = {
                    recipientEmail: document.getElementById('recipientEmail').value,
                    subject: document.getElementById('emailSubject').value,
                    message: document.getElementById('emailMessage').value,
                    quoteData: {}
                };
                
                // Add customer information
                const customerFields = ['firstName', 'lastName', 'companyName', 'email', 'phone', 'address1', 'address2', 'city', 'state', 'zip'];
                customerFields.forEach(field => {
                    const value = formData.get(field);
                    if (value) {
                        emailData.quoteData[field] = value;
                    }
                });
                
                // Add service details
                const rows = document.querySelectorAll('.service-row');
                emailData.quoteData.services = [];
                rows.forEach((row, index) => {
                    const rowData = row.querySelectorAll('input, textarea');
                    const service = {};
                    const rowIndexAttr = row.getAttribute('data-row');
                    rowData.forEach(input => {
                        if (input.type === 'hidden') {
                            if (input.name.startsWith('isSubscription')) {
                                if (input.value === 'true') {
                                    service[input.name] = 'true';
                                }
                            } else if (input.name.startsWith('subscriptionInterval')) {
                                const flag = rowIndexAttr !== null ? row.querySelector(`input[name="isSubscription${rowIndexAttr}"]`) : null;
                                if (flag && flag.value === 'true' && input.value) {
                                    service[input.name] = input.value;
                                }
                            } else if (input.value) {
                                service[input.name] = input.value;
                            }
                        } else if (input.value) {
                            service[input.name] = input.value;
                        }
                    });
                    if (Object.keys(service).length > 0) {
                        emailData.quoteData.services.push(service);
                    }
                });
                
                // Add total
                emailData.quoteData.oneTimeTotal = document.getElementById('oneTimeTotal')?.textContent || '0.00';
                emailData.quoteData.subscriptionMonthlyTotal = document.getElementById('subscriptionTotal')?.textContent || '0.00';
                emailData.quoteData.grandTotal = document.getElementById('grandTotal')?.textContent || '0.00';
                
                // Send to serverless function with bypass token
                const response = await fetch('/api/send-quote-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-vercel-protection-bypass': 'F9A72B1C8E5D4F0A6C3B7E2D9A8F5C1E'
                    },
                    body: JSON.stringify(emailData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success message
                    sendText.textContent = 'Email Sent!';
                    sendText.classList.remove('hidden');
                    sendLoading.classList.add('hidden');
                    sendBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    sendBtn.classList.add('bg-green-500');
                    
                    // Close modal after delay
                    setTimeout(() => {
                        closeEmailModal();
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Failed to send email');
                }
                
            } catch (error) {
                console.error('Error sending email:', error);
                
                // Show error state
                sendText.textContent = 'Error - Try Again';
                sendText.classList.remove('hidden');
                sendLoading.classList.add('hidden');
                sendBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                sendBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                
                // Reset after delay
                setTimeout(() => {
                    sendText.textContent = 'Send Quote';
                    sendBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    sendBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    sendBtn.disabled = false;
                }, 3000);
            }
        });

        // Close modal when clicking outside
        document.getElementById('emailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEmailModal();
            }
        });
    </script>
</body>
</html>
